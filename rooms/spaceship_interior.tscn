[gd_scene load_steps=19 format=3 uid="uid://chm0qadugd1jr"]

[ext_resource type="PackedScene" uid="uid://dg1ej1mcfp66g" path="res://main_menu.tscn" id="1_15rji"]
[ext_resource type="Texture2D" uid="uid://mp5gl8hyoewf" path="res://rooms/spaceship_interior.png" id="1_frnvw"]
[ext_resource type="Texture2D" uid="uid://gpnsci2k61oi" path="res://stars.png" id="1_hbhlg"]
[ext_resource type="Texture2D" uid="uid://e2l1gag5j0sc" path="res://island.png" id="2_7sfxr"]
[ext_resource type="Texture2D" uid="uid://fw6v6wihkuqw" path="res://characters/frog.png" id="3_5lqtw"]
[ext_resource type="Texture2D" uid="uid://cx2qjwnjbi22c" path="res://characters/captain.png" id="3_wmk4g"]
[ext_resource type="Texture2D" uid="uid://crp5j8668yh3b" path="res://characters/norbitt.png" id="5_v0nl7"]
[ext_resource type="FontVariation" uid="uid://dehhud25f044g" path="res://fonts/text.tres" id="8_fd5tv"]

[sub_resource type="GDScript" id="GDScript_1cr3o"]
script/source = "extends CanvasItem

var line = 0
var text = [
	\"Captain, land in sight!\", \"It is it. It's the Prism Island planet!\",
	
	\"Aye. Received, Norbitt.\",
	\"Oh boys, tell me if it doesn't look like a place where\" +
	\" you would hide a treasure.\",
	
	\"Well, Captain.\" +
	\" I agree that it looks like a place where one would hide a treasure...\",
	\"But are you sure we'll find Goldsuit Gus's treasure there?\",
	\"People say Prism Island is an exotic and dangerous planet.\",
	
	\"Gus lead many scientific misson to study the strange environment of that planet\",
	\" People said no one visited this planet ever since.\",
	
	\"but I think people did visit and turned around when they didn't\" +
	\" manage to solve his puzzles.\",
	\"That Gus loved puzzle and strange things, so if he was to hide something\" +
	\" that planet would be the perfect spot.\",
	
	\"O- Kay boys. Brace yourself, we're about to enter the planet's\" +
	\" rainbow field. Weirdness incoming.\",
	
	\"The rainbow field is messed with the spaceship systems.\",
	\"I think we're going to crash.\"
]
@onready
var label := $SubViewportContainer/CanvasLayer/Control/RichTextLabel
@onready
var anim_player := $AnimationPlayer

@export
var modulate_saturation: float = 0

func _ready() -> void:
	Globals.bgm_smooth_change(preload(\"res://music/Groovy Laboratory.ogg\"), 5)
	perform_cutscene()

var t: float = 0

func _process(delta: float) -> void:
	t += delta
	modulate = Color().from_hsv(t, modulate_saturation, 1)

func _input(event: InputEvent) -> void:
	if event.is_action_pressed(\"action\"):
		progress_dialogue()

func _on_character_timer_timeout() -> void:
	if line >= text.size():
		return
	label.text = text[line]
	if label.visible_characters >= 0:
		label.visible_characters += 1

func perform_cutscene():
	$SubViewportContainer.hide()
	#texture_filter = CanvasItem.TEXTURE_FILTER_LINEAR
	
	anim_player.play(\"transition_1\")
	await anim_player.animation_finished
	
	#texture_filter = CanvasItem.TEXTURE_FILTER_PARENT_NODE
	$SubViewportContainer.show()
	label.visible_characters = 0
	
	while line < 2:
		await get_tree().process_frame
	
	$Space.hide()
	$Control.hide()
	$Node2D.show()
	
	await dialogue_progressed
	
	$SubViewportContainer.hide()
	
	Globals.bgm_fade(.001, 4)
	anim_player.play(\"transition_2\")
	await anim_player.animation_finished
	
	$SubViewportContainer.show()
	display_line(12)
	$Node2D/Polygon2D.accelerate = true
	
	await dialogue_progressed
	
	anim_player.play(\"transition_3\")
	await anim_player.animation_finished
	
	get_tree().change_scene_to_file(\"res://rooms/seaside_1.tscn\")

signal dialogue_progressed()

func progress_dialogue():
	if !label.is_visible_in_tree() or !$SubViewportContainer.visible:
		return
	
	if label.visible_ratio < 1:
		label.visible_characters = -1
		return
	
	match line:
		11, 13:
			dialogue_progressed.emit()
			return
	
	display_line(line + 1)

func display_line(new_line: int):
	line = new_line
	label.visible_characters = 0
"

[sub_resource type="AtlasTexture" id="AtlasTexture_6amgu"]
atlas = ExtResource("2_7sfxr")
region = Rect2(288, 0, 288, 288)

[sub_resource type="GDScript" id="GDScript_mh4qa"]
script/source = "extends Polygon2D

var accelerate:bool = false

var velocity: float = 100
# Called when the node enters the scene tree for the first time.
func _ready() -> void:
	pass # Replace with function body.


# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta: float) -> void:
	
	if accelerate:
		velocity += delta * 50
	
	texture_offset.y += delta * velocity
"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_hnx71"]
content_margin_left = 32.0
content_margin_top = 16.0
content_margin_right = 32.0
content_margin_bottom = 16.0
bg_color = Color(0, 0, 0, 1)
border_width_left = 4
border_width_top = 4
border_width_right = 4
border_width_bottom = 4
border_color = Color(1, 1, 1, 1)

[sub_resource type="CanvasItemMaterial" id="CanvasItemMaterial_pl6b8"]
light_mode = 1

[sub_resource type="Animation" id="Animation_5efsi"]
length = 0.001
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Control/Oblo:scale")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector2(2.5, 2.5)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("Control:scale")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector2(1, 1)]
}
tracks/2/type = "value"
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/path = NodePath(".:modulate_saturation")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [0.0]
}
tracks/3/type = "value"
tracks/3/imported = false
tracks/3/enabled = true
tracks/3/path = NodePath("Space2:modulate")
tracks/3/interp = 1
tracks/3/loop_wrap = true
tracks/3/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Color(1, 1, 1, 0)]
}
tracks/4/type = "value"
tracks/4/imported = false
tracks/4/enabled = true
tracks/4/path = NodePath("Space2:visible")
tracks/4/interp = 1
tracks/4/loop_wrap = true
tracks/4/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 1,
"values": [false]
}

[sub_resource type="Animation" id="Animation_rrbcc"]
resource_name = "transition_1"
length = 2.0
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Control/Oblo:scale")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 2),
"transitions": PackedFloat32Array(0.5, 0.5),
"update": 0,
"values": [Vector2(2.5, 2.5), Vector2(2.5, 2.5)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("Control:scale")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0, 2),
"transitions": PackedFloat32Array(0.5, 1),
"update": 0,
"values": [Vector2(1, 1), Vector2(0.5, 0.5)]
}

[sub_resource type="Animation" id="Animation_sprlp"]
resource_name = "transition_2"
length = 4.0
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath(".:modulate_saturation")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 2, 4),
"transitions": PackedFloat32Array(1, 1, 1),
"update": 0,
"values": [0.0, 1.0, 1.0]
}

[sub_resource type="Animation" id="Animation_v8l7h"]
resource_name = "transition_3"
length = 4.0
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Space2:modulate")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 1, 3, 4),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 0,
"values": [Color(1, 1, 1, 0), Color(1, 1, 1, 0), Color(0.74902, 0.74902, 0.74902, 1), Color(0.74902, 0.74902, 0.74902, 1)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("Space2:visible")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0, 4),
"transitions": PackedFloat32Array(1, 1),
"update": 1,
"values": [true, true]
}
tracks/2/type = "value"
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/path = NodePath(".:modulate_saturation")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/keys = {
"times": PackedFloat32Array(0, 1, 3, 4),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 0,
"values": [1.0, 1.0, 0.0, 0.0]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_wm6yv"]
_data = {
"RESET": SubResource("Animation_5efsi"),
"transition_1": SubResource("Animation_rrbcc"),
"transition_2": SubResource("Animation_sprlp"),
"transition_3": SubResource("Animation_v8l7h")
}

[node name="Node2D" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_1cr3o")

[node name="Space" type="Polygon2D" parent="."]
texture_repeat = 2
texture = ExtResource("1_hbhlg")
polygon = PackedVector2Array(0, 0, 512, 0, 512, 288, 0, 288)

[node name="Control" parent="." instance=ExtResource("1_15rji")]
custom_minimum_size = Vector2(512, 288)
layout_mode = 1
pivot_offset = Vector2(256, 144)

[node name="Polygon2D" parent="Control" index="0"]
visible = false

[node name="VBoxContainer" parent="Control" index="3"]
visible = false

[node name="Oblo" type="Sprite2D" parent="Control"]
position = Vector2(256, 144)
scale = Vector2(2.5, 2.5)
texture = SubResource("AtlasTexture_6amgu")

[node name="Polygon2D" type="Polygon2D" parent="Control/Oblo"]
color = Color(0, 0, 0, 1)
invert_enabled = true
invert_border = 200.0
polygon = PackedVector2Array(-136, -144, -136, 144, 136, 144, 136, -144)

[node name="Node2D" type="Node2D" parent="."]
visible = false

[node name="Polygon2D" type="Polygon2D" parent="Node2D"]
texture_repeat = 2
texture = ExtResource("1_hbhlg")
polygon = PackedVector2Array(0, 0, 512, 0, 512, 288, 0, 288)
script = SubResource("GDScript_mh4qa")

[node name="Sprite2D" type="Sprite2D" parent="Node2D"]
position = Vector2(256, 144)
texture = ExtResource("1_frnvw")
region_enabled = true
region_rect = Rect2(32, 0, 192, 288)

[node name="Sprite2D2" type="Sprite2D" parent="Node2D"]
use_parent_material = true
position = Vector2(256, 112)
texture = ExtResource("3_wmk4g")
hframes = 4

[node name="Sprite2D3" type="Sprite2D" parent="Node2D"]
use_parent_material = true
position = Vector2(208, 128)
texture = ExtResource("3_5lqtw")
hframes = 4

[node name="Sprite2D4" type="Sprite2D" parent="Node2D"]
use_parent_material = true
position = Vector2(304, 128)
texture = ExtResource("5_v0nl7")
hframes = 4

[node name="SubViewportContainer" type="SubViewportContainer" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_right = 512.0
offset_bottom = 288.0
grow_horizontal = 2
grow_vertical = 2
scale = Vector2(0.5, 0.5)
stretch = true

[node name="CanvasLayer" type="SubViewport" parent="SubViewportContainer"]
transparent_bg = true
handle_input_locally = false
size = Vector2i(1024, 576)
render_target_update_mode = 4

[node name="Control" type="Control" parent="SubViewportContainer/CanvasLayer"]
custom_minimum_size = Vector2(0, 144)
layout_mode = 3
anchors_preset = 12
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 0

[node name="RichTextLabel" type="RichTextLabel" parent="SubViewportContainer/CanvasLayer/Control"]
layout_mode = 1
anchors_preset = -1
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 8.0
offset_top = 8.0
offset_right = -8.0
offset_bottom = -8.0
grow_horizontal = 2
grow_vertical = 2
theme_override_fonts/normal_font = ExtResource("8_fd5tv")
theme_override_font_sizes/normal_font_size = 32
theme_override_styles/normal = SubResource("StyleBoxFlat_hnx71")
text = "Lorem Ipsum
Dolor sit Amet"
scroll_active = false
visible_characters_behavior = 1

[node name="Space2" type="Polygon2D" parent="."]
visible = false
modulate = Color(1, 1, 1, 0)
texture_repeat = 2
material = SubResource("CanvasItemMaterial_pl6b8")
polygon = PackedVector2Array(0, 0, 512, 0, 512, 288, 0, 288)

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
libraries = {
"": SubResource("AnimationLibrary_wm6yv")
}

[node name="CharacterTimer" type="Timer" parent="."]
process_callback = 0
wait_time = 0.01
autostart = true

[connection signal="timeout" from="CharacterTimer" to="." method="_on_character_timer_timeout"]

[editable path="Control"]
